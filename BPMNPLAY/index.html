<!DOCTYPE html>
<html>
<head>

    <script type="text/javascript">
        var ctx = null;
        var gameMap = [
            1, 1, 1, 1, 1, 1, 1, 1,
            1, 0, 0, 0, 0, 0, 0, 1,
            1, 0, 0, 0, 0, 0, 0, 1,
            1, 0, 0, 0, 0, 0, 0, 1,
            1, 0, 0, 0, 0, 0, 0, 1,
            1, 0, 0, 0, 0, 0, 0, 1,
            1, 0, 0, 0, 0, 0, 0, 1,
            1, 1, 1, 1, 1, 1, 1, 1

        ];

        var colorMap = [];
        var anchoCasilla = 80, altoCasilla = 80;
        var columnas = 8, filas = 8;
        var anchoCanvas = 640, altoCanvas = 640;
        var currentSecond = 0, frameCount = 0, framesLastSecond = 0, lastFrameTime = 0;

        var keysDown = {
            37 : false,
            38 : false,
            39 : false,
            40 : false
        };
        var player = new Character();

        var color1 = new Image();
        var color2 = new Image();
        var color3 = new Image();

        var patterColor1
        var patterColor2
        var patterColor3

        window.onload = function() {
            seleccionarColor();
            console.log(colorMap);
            ctx = document.getElementById('game').getContext("2d");

            ctx.font = "bold 10pt sans-serif";

            color1.src = "0.png";
            color2.src = "1.png";
            color3.src = "2.png";

            requestAnimationFrame(drawGame);

            window.addEventListener("keydown", function(e) {
                if(e.keyCode>=37 && e.keyCode<=40) { keysDown[e.keyCode] = true; }
            });
            window.addEventListener("keyup", function(e) {
                if(e.keyCode>=37 && e.keyCode<=40) { keysDown[e.keyCode] = false; }
            });

        };

        function seleccionarColor() {
            var indice=0;
            for(var y = 0; y < filas; ++y)
            {
                for(var x = 0; x < columnas; ++x)
                {
                    switch(gameMap[((y*columnas)+x)])
                    {
                        case 0:
                           colorMap[indice]=-1;
                           indice++;
                            break;
                        default:
                            var colorA = Math.floor(Math.random()*3);
                            switch (colorA)
                            {
                                case 0:
                                    colorMap[indice]=0;
                                    indice++;
                                    break;
                                case 1:
                                    colorMap[indice]=1;
                                    indice++;
                                    break;
                                case 2:
                                    colorMap[indice]=2;
                                    indice++;
                                    break;
                                default:

                            }
                    }
                }
            }
        }

        function dibujarCasillas() {
            for(var i=0;i<=8;i++)
            {
                for( var j=0;j<=8;j++)
                {
                    ctx.strokeStyle= "#000000"
                    ctx.moveTo(0,0);
                    ctx.lineTo(0,altoCanvas);
                    ctx.lineTo(anchoCanvas,altoCanvas);
                    ctx.lineTo(anchoCanvas,0);
                    ctx.lineTo(0,0);
                    ctx.moveTo(0,anchoCasilla*j);
                    ctx.lineTo(anchoCasilla,anchoCasilla*j);
                    ctx.lineTo(anchoCasilla,altoCanvas);
                    ctx.moveTo(anchoCasilla*i,altoCanvas);
                    ctx.lineTo(anchoCasilla*i,(altoCanvas - anchoCasilla));
                    ctx.moveTo((anchoCanvas - anchoCasilla),altoCanvas);
                    ctx.lineTo((anchoCanvas - anchoCasilla),anchoCasilla);
                    ctx.moveTo(anchoCasilla*i,0);
                    ctx.lineTo(anchoCasilla*i,anchoCasilla);
                    ctx.lineTo(anchoCanvas,anchoCasilla);
                    ctx.moveTo(anchoCanvas,(altoCanvas - anchoCasilla));
                    ctx.lineTo(anchoCasilla,(altoCanvas - anchoCasilla));
                    ctx.moveTo((anchoCanvas - anchoCasilla) ,anchoCasilla*i);
                    ctx.lineTo(anchoCanvas,anchoCasilla*i);
                    ctx.stroke();
                }};
        }

        function agregarNumerosCasilla() {
            var num1 = 1, num2 = 8, num3 = 20, num4 = 27;
            for(var y = 0; y < filas; ++y) {
                for (var x = 0; x < columnas; ++x) {

                    if(y==0) {
                        if(x==0 && y==0) {var as = insertarNumero(x,y,"Inicio",1) }
                        else {num1 = insertarNumero(x,y,num1,1)};
                    }
                    if(x==0 && y != 0) {
                        num4 = insertarNumero(x,y,num4,-1);
                    }
                    if(x==7 && y != 0) {
                        num2 = insertarNumero(x,y,num2, 1);
                    }
                    if(x!=0 && x != 7 && y==7) {
                        num3 = insertarNumero(x,y,num3,-1);
                    }
                }
            }
        }

        function insertarNumero(x, y, num, sig) {
            ctx.fillStyle = "#000000";
            ctx.fillText(num+"", x * anchoCasilla + (anchoCasilla / 2)-10, y * altoCasilla + (altoCasilla / 2)+5, 40, 40);
            num+=(1*sig);
            return num;
        }

        function Character()   {
            this.tileFrom	= [0,0];
            this.tileTo		= [0,0];
            this.timeMoved	= 0;
            this.dimensions	= [40,40];
            this.position	= [20,20];
            this.delayMove	= 700;
        }

        Character.prototype.placeAt = function(x, y) {
            this.tileFrom	= [x,y];
            this.tileTo		= [x,y];
            this.position	= [((anchoCasilla*x)+((altoCasilla-this.dimensions[0])/2)),
                ((altoCasilla*y)+((altoCasilla-this.dimensions[1])/2))];
        };

        Character.prototype.processMovement = function(t) {
            if(this.tileFrom[0]==this.tileTo[0] && this.tileFrom[1]==this.tileTo[1]) { return false; }

            if((t-this.timeMoved)>=this.delayMove)
            {
                this.placeAt(this.tileTo[0], this.tileTo[1]);
            }
            else
            {
                this.position[0] = (this.tileFrom[0] * anchoCasilla) + ((anchoCasilla-this.dimensions[0])/2);
                this.position[1] = (this.tileFrom[1] * altoCasilla) + ((altoCasilla-this.dimensions[1])/2);

                if(this.tileTo[0] != this.tileFrom[0])
                {
                    var diff = (anchoCasilla / this.delayMove) * (t-this.timeMoved);
                    this.position[0]+= (this.tileTo[0]<this.tileFrom[0] ? 0 - diff : diff);
                }
                if(this.tileTo[1] != this.tileFrom[1])
                {
                    var diff = (altoCasilla / this.delayMove) * (t-this.timeMoved);
                    this.position[1]+= (this.tileTo[1]<this.tileFrom[1] ? 0 - diff : diff);
                }

                this.position[0] = Math.round(this.position[0]);
                this.position[1] = Math.round(this.position[1]);
            }

            return true;
        }

        function toIndex(x, y) {
            return((y * columnas) + x);
        }

        function drawGame() {
            if(ctx==null) { return; }


        var currentFrameTime = Date.now();
        var timeElapsed = currentFrameTime - lastFrameTime;

        var sec = Math.floor(Date.now()/1000);
        if(sec!=currentSecond)
        {
            currentSecond = sec;
            framesLastSecond = frameCount;
            frameCount = 1;
        }
        else { frameCount++; }

        if(!player.processMovement(currentFrameTime))
        {
            //Mover arriba
            if(keysDown[38] && player.tileFrom[1]>0 && gameMap[toIndex(player.tileFrom[0], player.tileFrom[1]-1)]==1) { player.tileTo[1]-= 1; }
           // Mover abajo
            else if(keysDown[40] && player.tileFrom[1]<(filas-1) && gameMap[toIndex(player.tileFrom[0], player.tileFrom[1]+1)]==1) { player.tileTo[1]+= 1; }
            // Mover izquierda
            else if(keysDown[37] && player.tileFrom[0]>0 && gameMap[toIndex(player.tileFrom[0]-1, player.tileFrom[1])]==1) { player.tileTo[0]-= 1; }
            // Mover derecha
            else if(keysDown[39] && player.tileFrom[0]<(columnas-1) && gameMap[toIndex(player.tileFrom[0]+1, player.tileFrom[1])]==1) { player.tileTo[0]+= 1; }

            if(player.tileFrom[0]!=player.tileTo[0] || player.tileFrom[1]!=player.tileTo[1])
            { player.timeMoved = currentFrameTime; }
        }
            for(var y = 0; y < filas; ++y)
            {
                for(var x = 0; x < columnas; ++x)
                {
                    color1.src = '0.png';
                    color2.src = '1.png';
                    color3.src = '2.png';
                    patterColor1 = ctx.createPattern(color1,"repeat");
                    patterColor2 = ctx.createPattern(color2,"repeat");
                    patterColor3 = ctx.createPattern(color3,"repeat");


                    switch(gameMap[((y*columnas)+x)])
                    {
                        case 0:
                            ctx.fillStyle = "#685b48";
                            break;
                        default:
                            switch (colorMap[((y*columnas)+x)])
                            {
                                case 0:
                                    console.log(patterColor1)
                                    ctx.fillStyle = patterColor1;
                                    break;
                                case 1:
                                    ctx.fillStyle = patterColor2;
                                    break;
                                case 2:
                                    ctx.fillStyle = patterColor3;
                                    break;
                                default:
                                    ctx.fillStyle = "#5aa457";
                            }
                    }
                    ctx.fillRect( x*anchoCasilla, y*altoCasilla, anchoCasilla, altoCasilla);

                }

            }
            agregarNumerosCasilla();

            ctx.fillStyle = "#000000";
            ctx.fillRect(player.position[0], player.position[1],
            player.dimensions[0], player.dimensions[1]);
            ctx.fillStyle = "#ff0000";
            ctx.fillText("FPS: " + framesLastSecond, 10, 40);

            lastFrameTime = currentFrameTime;
            requestAnimationFrame(drawGame);
        }


    </script>

</head>
<body>
    <canvas id="game" width="640" height="640"></canvas>
</body>
</html>