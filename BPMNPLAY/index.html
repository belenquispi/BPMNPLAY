<!DOCTYPE html>
<!--suppress ALL -->
<html>
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css">
    <script type="text/javascript">
        var ctx = null;
        /*var gameMap = [
            1, 1, 1, 1, 1, 1, 1, 1,
            1, 0, 0, 0, 0, 0, 0, 1,
            1, 1, 1, 0, 0, 1, 1, 1,
            0, 0, 1, 0, 0, 1, 0, 0,
            0, 0, 1, 0, 0, 1, 0, 0,
            1, 1, 1, 0, 0, 1, 1, 1,
            1, 0, 0, 0, 0, 0, 0, 1,
            1, 1, 1, 0, 0, 1, 1, 1

        ];*/
        var gameMap = [
            13, 14, 15, 16, 17, 18, 19, 20,
            12, 0,  0,  0,  0,  0,  0,  21,
            11, 10, 9,  0,  0,  24, 23, 22,
            0,  0,  8,  0,  0,  25, 0,  0,
            0,  0,  7,  0,  0,  26, 0,  0,
            4,  5,  6,  0,  0,  27, 28, 29,
            3,  0,  0,  0,  0,  0,  0,  30,
            2,  1,  "Inicio",  0,  0,  33, 32, 31

        ];
        var colorMap = [];
        var colorJugador = ["#01DF3A","#FE2E2E","#0431B4","#61380B","#8904B1"]
        var anchoCasilla = 80, altoCasilla = 80;
        var columnas = 8, filas = 8;
        var currentSecond = 0, frameCount = 0, framesLastSecond = 0, lastFrameTime = 0;
        var clic1 =  false;
        var clic2 = false;
        var clic3 = false;
        var clic4 = false;
        var dado = -1;
        var elPrimerJugador = "";
        var gameTime = 0;
        var gameSpeeds = [
            {name:"Normal", mult:1},
            {name:"Paused", mult:0}
        ];
        var currentSpeed = 0;
        var directions = {
            up		: 0,
            right	: 1,
            down	: 2,
            left	: 3
        };
        var jugadorActual = new Character();
        var jugador1 = new Character(0);
        var jugador2 = new Character(1);
        var jugador3 = new Character(2);
        var jugador4 = new Character(3);
        var color1 = new Image();
        var color2 = new Image();
        var color3 = new Image();
        var patterColor1, patterColor2, patterColor3;

        function Character(c)   {
            this.tileFrom	= [2,7];
            this.tileTo		= [2,7];
            this.timeMoved	= 0;
            this.dimensions	= [40,40];
            this.position	= [180,580];
            this.delayMove	= 100;
            this.direction	= directions.up;
            this.casilla = 0;
            this.colorP = colorJugador[c];
            this.boton = "";
        }

        Character.prototype.placeAt = function(x, y) {
            this.tileFrom	= [x,y];
            this.tileTo		= [x,y];
            this.position	= [((anchoCasilla*x)+((anchoCasilla-this.dimensions[0])/2)),
                ((altoCasilla*y)+((altoCasilla-this.dimensions[1])/2))];
        };

        Character.prototype.processMovement = function(t) {
            if(this.tileFrom[0]==this.tileTo[0] && this.tileFrom[1]==this.tileTo[1]) { return false; }

            if (jugadorActual.casilla == 33)
            {
                console.log(jugadorActual.boton);
                console.log("hola");
                ocultarBoton(jugadorActual.boton)
                //currentSpeed = (currentSpeed>=(gameSpeeds.length-1) ? 0 : currentSpeed+1);
                dado = 0;
            }


            if((t-this.timeMoved)>=this.delayMove)
            {
                this.placeAt(this.tileTo[0], this.tileTo[1]);
                console.log ("quieto" + this.casilla);

                if(dado > 1 )
                {
                    if(this.canMoveDirection(this.direction))
                    {
                        this.moveDirection(this.direction, t);
                    }
                    else
                    {
                        this.nuevaDireccion();
                        this.moveDirection(this.direction, t);
                    }
                    dado = dado - 1;
                }
                else
                {
                    clic1 = false;
                    clic2 = false;
                    clic3 = false;
                    clic4 = false;
                }
            }
            else
            {
                this.position[0] = (this.tileFrom[0] * anchoCasilla) + ((anchoCasilla-this.dimensions[0])/2);
                this.position[1] = (this.tileFrom[1] * altoCasilla) + ((altoCasilla-this.dimensions[1])/2);

                if(this.tileTo[0] != this.tileFrom[0])
                {
                    var diff = (anchoCasilla / this.delayMove) * (t-this.timeMoved);
                    this.position[0]+= (this.tileTo[0]<this.tileFrom[0] ? 0 - diff : diff);
                }
                if(this.tileTo[1] != this.tileFrom[1])
                {
                    var diff = (altoCasilla / this.delayMove) * (t-this.timeMoved);
                    this.position[1]+= (this.tileTo[1]<this.tileFrom[1] ? 0 - diff : diff);
                }

                this.position[0] = Math.round(this.position[0]);
                this.position[1] = Math.round(this.position[1]);
            }
            return true;
        }

        Character.prototype.canMoveTo = function(x, y)     {
            if(x < 0 || x >= columnas || y < 0 || y >= filas) { return false; }
            else if([gameMap[toIndex(x,y)]]== 0 ) {  return false; }
            else if([gameMap[((y*columnas)+x)]] < this.casilla) { return false;}
            return true;
        };

        Character.prototype.canMoveUp		= function() { return this.canMoveTo(this.tileFrom[0], this.tileFrom[1]-1); };

        Character.prototype.canMoveDown 	= function() { return this.canMoveTo(this.tileFrom[0], this.tileFrom[1]+1); };

        Character.prototype.canMoveLeft 	= function() { return this.canMoveTo(this.tileFrom[0]-1, this.tileFrom[1]); };

        Character.prototype.canMoveRight 	= function() { console.log("dere: " + this.tileFrom[0], this.tileFrom[1] ); return this.canMoveTo(this.tileFrom[0]+1, this.tileFrom[1]); };

        Character.prototype.canMoveDirection = function(d) {
            switch(d)
            {
                case directions.up:
                    return this.canMoveUp();
                case directions.down:
                    return this.canMoveDown();
                case directions.left:
                    return this.canMoveLeft();
                default:
                    return this.canMoveRight();
            }
        };

        Character.prototype.nuevaDireccion = function() {

            if(this.canMoveRight()){this.direction = directions.right}
            else {if(this.canMoveLeft()){this.direction = directions.left}
            else {if(this.canMoveDown()){this.direction = directions.down}
            else {if(this.canMoveUp()){this.direction = directions.up}}}}


        }

        Character.prototype.moveLeft	= function(t) { this.tileTo[0]-=1; this.timeMoved = t; this.direction = 3; this.casilla += 1;};

        Character.prototype.moveRight	= function(t) { this.tileTo[0]+=1; this.timeMoved = t; this.direction = 1; this.casilla += 1;};

        Character.prototype.moveUp	= function(t) { this.tileTo[1]-=1; this.timeMoved = t; this.direction = 0; this.casilla += 1;};

        Character.prototype.moveDown	= function(t) { this.tileTo[1]+=1; this.timeMoved = t; this.direction = 2; this.casilla += 1;};

        Character.prototype.moveDirection = function(d, t) { switch(d) {
            case directions.up:
                return this.moveUp(t);
            case directions.down:
                return this.moveDown(t);
            case directions.left:
                return this.moveLeft(t);
            default:
                return this.moveRight(t);
        } };

        function toIndex(x, y) {
            return((y * columnas) + x);
        }

        window.onload = function() {
            seleccionarColor();
            ctx = document.getElementById('game').getContext("2d");
            requestAnimationFrame(drawGame);
            ctx.font = "bold 10pt sans-serif";
            color1.src = "0.png";
            color2.src = "1.png";
            color3.src = "2.png";
            document.getElementById("boton1").addEventListener("click",function () {
                jugadorActual = jugador1;
                jugadorActual.boton = "boton1";
                clic1 = true;
            });
            document.getElementById("boton2").addEventListener("click",function () {
                jugadorActual = jugador2;
                jugadorActual.boton = "boton2";
                clic2 = true;
            });
            document.getElementById("boton3").addEventListener("click",function () {
                jugadorActual = jugador3;
                jugadorActual.boton = "boton3";
                clic3 = true;
            });
            document.getElementById("boton4").addEventListener("click",function () {
                jugadorActual = jugador4;
                jugadorActual.boton = "boton4";
                clic4 = true;
            })

            window.addEventListener("keyup", function(e) {
                if(e.keyCode==83)
                {
                    currentSpeed = (currentSpeed>=(gameSpeeds.length-1) ? 0 : currentSpeed+1);

                }
            })
        };

        function seleccionarColor() {
            var indice=0;
            for(var y = 0; y < filas; ++y)
            {
                for(var x = 0; x < columnas; ++x)
                {
                    switch(gameMap[((y*columnas)+x)])
                    {
                        case 0:
                            colorMap[indice]=-1;
                            indice++;
                            break;
                        default:
                            var colorA = Math.floor(Math.random()*3);
                            switch (colorA)
                            {
                                case 0:
                                    colorMap[indice]=0;
                                    indice++;
                                    break;
                                case 1:
                                    colorMap[indice]=1;
                                    indice++;
                                    break;
                                case 2:
                                    colorMap[indice]=2;
                                    indice++;
                                    break;
                                default:

                            }
                    }
                }
            }
        }

        function agregarNumerosCasilla() {
            for(var y = 0; y < filas; ++y) {
                for (var x = 0; x < columnas; ++x) {
                    switch(gameMap[((y*columnas)+x)]) {
                        case 0:
                            //ctx.fillStyle = "#685b48";
                            break;
                        default:
                            ctx.fillStyle = "#000000";
                            ctx.fillText(gameMap[((y*columnas)+x)], x*anchoCasilla+anchoCasilla/2, y*altoCasilla+anchoCasilla/2, anchoCasilla/2, altoCasilla/2);

                    }


                }
            }
        }

        function insertarNumero(x, y, num, sig) {
            ctx.fillStyle = "#000000";
            ctx.fillText(num+"", x * anchoCasilla + (anchoCasilla / 2)-10, y * altoCasilla + (altoCasilla / 2)+5, 40, 40);
            num+=(1*sig);
            return num;
        }

        function dadoRandomico() {
            dado = Math.floor(Math.random()*6+1);
            console.log("Numero"+dado);
        }

        function ocultarBoton(boton) {

            document.getElementById(boton).style.visibility = 'hidden';
        }

        function actualizarCasilla(){
            document.getElementById('jugador1').innerHTML = (jugador1.casilla).toString();
            document.getElementById('jugador2').innerHTML = (jugador2.casilla).toString();
            document.getElementById('jugador3').innerHTML = (jugador3.casilla).toString();
            document.getElementById('jugador4').innerHTML = (jugador4.casilla).toString();
        }

        function elPrimero() {
            ordenar();
            switch(elPrimerJugador)
            {
                case "corona1":
                {
                    // console.log("uno primero")
                    document.getElementById("corona1").style.visibility = 'visible';
                    document.getElementById("corona2").style.visibility = 'hidden';
                    document.getElementById("corona3").style.visibility = 'hidden';
                    document.getElementById("corona4").style.visibility = 'hidden';
                    break;

                }
                case "corona2":
                {
                    document.getElementById("corona2").style.visibility = 'visible';
                    document.getElementById("corona1").style.visibility = 'hidden';
                    document.getElementById("corona3").style.visibility = 'hidden';
                    document.getElementById("corona4").style.visibility = 'hidden';
                    break;

                }
                case "corona3":
                {
                    document.getElementById("corona3").style.visibility = 'visible';
                    document.getElementById("corona1").style.visibility = 'hidden';
                    document.getElementById("corona2").style.visibility = 'hidden';
                    document.getElementById("corona4").style.visibility = 'hidden';
                    break;

                }
                case "corona4":
                {
                    document.getElementById("corona4").style.visibility = 'visible';
                    document.getElementById("corona1").style.visibility = 'hidden';
                    document.getElementById("corona2").style.visibility = 'hidden';
                    document.getElementById("corona3").style.visibility = 'hidden';
                    break;
                }
                default:
                {
                    document.getElementById("corona4").style.visibility = 'hidden';
                    document.getElementById("corona1").style.visibility = 'hidden';
                    document.getElementById("corona2").style.visibility = 'hidden';
                    document.getElementById("corona3").style.visibility = 'hidden';
                }

            }
        }

        function ordenar() {
            console.log("puesto1" + " "+jugador1.casilla);
            console.log("puesto2" + " "+jugador2.casilla);
            if(jugador1.casilla > jugador2.casilla && jugador1.casilla > jugador3.casilla && jugador1.casilla > jugador4.casilla )
            {

                return elPrimerJugador = "corona1";
            }
            else if(jugador2.casilla > jugador1.casilla && jugador2.casilla > jugador3.casilla && jugador2.casilla > jugador4.casilla )
            {
                return elPrimerJugador = "corona2";
            }
            else if(jugador3.casilla > jugador1.casilla && jugador3.casilla > jugador2.casilla && jugador3.casilla > jugador4.casilla )
            {
                return elPrimerJugador = "corona3";
            }
            else if(jugador4.casilla > jugador1.casilla && jugador4.casilla > jugador2.casilla && jugador4.casilla > jugador3.casilla )
            {
                return elPrimerJugador = "corona4";
            }

            elPrimerJugador = 0;

        }

        function drawGame() {
            if(ctx==null) { return; }
            var currentFrameTime = Date.now();
            var timeElapsed = currentFrameTime - lastFrameTime;
            gameTime+= Math.floor(timeElapsed * gameSpeeds[currentSpeed].mult);
            actualizarCasilla();
            var sec = Math.floor(Date.now()/1000);
            if(sec!=currentSecond) {
                currentSecond = sec;
                framesLastSecond = frameCount;
                frameCount = 1;
            }
            else { frameCount++; }

            if(!jugadorActual.processMovement(gameTime) && gameSpeeds[currentSpeed].mult!=0) {
                if(clic1 || clic2 || clic3 || clic4)
                {
                    if(jugadorActual.casilla <= 33)
                    {
                        dadoRandomico();
                        if(jugadorActual.canMoveUp() )			{  jugadorActual.moveUp(gameTime);  console.log("dado");}
                        else if(jugadorActual.canMoveDown() )	{  jugadorActual.moveDown(gameTime); console.log("dado");}
                        else if(jugadorActual.canMoveLeft() )	{  jugadorActual.moveLeft(gameTime); console.log("dado");}
                        else if(jugadorActual.canMoveRight()  )	{  jugadorActual.moveRight(gameTime); console.log("dado");}

                    }
                }
            }

            elPrimero();

            for(var y = 0; y < filas; ++y) {
                for(var x = 0; x < columnas; ++x) {
                    color1.src = '0.png';
                    color2.src = '1.png';
                    color3.src = '2.png';
                    patterColor1 = ctx.createPattern(color1,"repeat");
                    patterColor2 = ctx.createPattern(color2,"repeat");
                    patterColor3 = ctx.createPattern(color3,"repeat");

                    switch(gameMap[((y*columnas)+x)]) {
                        case 0:
                            ctx.fillStyle = "#6A0888";
                            break;
                        default:
                            switch (colorMap[((y*columnas)+x)])
                            {
                                case 0:
                                    ctx.fillStyle = patterColor1;
                                    break;
                                case 1:
                                    ctx.fillStyle = patterColor2;
                                    break;
                                case 2:
                                    ctx.fillStyle = patterColor3;
                                    break;
                                default:
                                    ctx.fillStyle = "#5aa457";
                            }
                    }
                    ctx.fillRect( x*anchoCasilla, y*altoCasilla, anchoCasilla, altoCasilla);
                }
            }

            agregarNumerosCasilla();

            ctx.fillStyle = jugador1.colorP
            ctx.fillRect(jugador1.position[0], jugador1.position[1], jugador1.dimensions[0]/2, jugador1.dimensions[1]/2);

            ctx.fillStyle = jugador2.colorP
            ctx.fillRect(jugador2.position[0]+(jugador1.dimensions[0]/2), jugador2.position[1], jugador2.dimensions[0]/2, jugador2.dimensions[1]/2);

            ctx.fillStyle = jugador3.colorP
            ctx.fillRect(jugador3.position[0], (jugador3.position[1]+jugador1.dimensions[0]/2), jugador3.dimensions[0]/2, jugador3.dimensions[1]/2);

            ctx.fillStyle = jugador4.colorP
            ctx.fillRect(jugador4.position[0]+(jugador4.dimensions[0]/2), jugador4.position[1]+(jugador4.dimensions[0]/2), jugador4.dimensions[0]/2, jugador4.dimensions[1]/2);


            ctx.fillStyle = "#ff0000";
            ctx.fillText("FPS: " + framesLastSecond, 10, 20);

            lastFrameTime = currentFrameTime;
            requestAnimationFrame(drawGame);
        }


    </script>

</head>
<body>
<div class="container-fluid">
    <div class="row">
        <div class="col-md-7">
            <canvas id="game" width="640" height="640"></canvas>
        </div>
        <div class="col-md-5">
            <table class="table">
                <thead>
                <tr>
                    <th>Jugador</th>
                    <th>Casilla</th>
                    <th>Primer lugar</th>
                </tr>
                </thead>
                <tbody>
                <tr>
                    <td> <button id="boton1">Jugador 1</button></td>
                    <td> <label id="jugador1">1</label></td>
                    <td><img id="corona1" src="corona.png" alt="corona" height="50" width="50" style="visibility: hidden"></td>
                </tr>
                <tr>
                    <td> <button id="boton2">Jugador 2</button></td>
                    <td> <label id="jugador2">1</label></td>
                    <td><img id="corona2" src="corona.png" alt="corona" height="50" width="50" style="visibility: hidden"></td>
                </tr>
                <tr>
                    <td> <button id="boton3">Jugador 3</button></td>
                    <td> <label id="jugador3">1</label></td>
                    <td><img id="corona3" src="corona.png" alt="corona" height="50" width="50" style="visibility: hidden" ></td>
                </tr>
                <tr>
                    <td> <button id="boton4">Jugador 4</button></td>
                    <td> <label id="jugador4">1</label></td>
                    <td><img id="corona4" src="corona.png" alt="corona" height="50" width="50" style="visibility: hidden"></td>
                </tr>
                </tbody>
            </table>

        </div>
    </div>

</div>
</body>
</html>